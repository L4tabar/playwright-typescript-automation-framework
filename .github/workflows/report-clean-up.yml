name: Clean up gh-pages folders

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  cleanup-gh-pages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: List remote branches
        id: branches
        run: |
          git fetch --prune origin '+refs/heads/*:refs/remotes/origin/*'
          git for-each-ref --format='%(refname:short)' refs/remotes/origin/ | sed 's|origin/||' > branches.txt
          echo "existing<<EOF" >> $GITHUB_OUTPUT
          cat branches.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Clean up deleted branch folders
        run: |
          EXISTING=()
          while IFS= read -r branch; do
            EXISTING+=("$branch")
          done <<< "${{ steps.branches.outputs.existing }}"

          for DIR in */ ; do
            DIR=${DIR%/}
            if [[ ! " ${EXISTING[@]} " =~ " ${DIR} " ]]; then
              rm -rf "$DIR"
            fi
          done

          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add .
            git commit -m "Remove gh-pages folders for deleted branches"
            git push origin gh-pages
          fi
